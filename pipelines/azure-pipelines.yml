trigger:
  branches:
    include:
      - main

stages:
- stage: Deploy
  displayName: "Terraform Infrastructure Deployment"
  jobs:
  - job: terraform
    pool:
      vmImage: "ubuntu-latest"
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: "Azure CLI Login"
      inputs:
        azureSubscription: "tf-sp-iac-demo"  # Service connection name
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: echo "âœ… Logged in to Azure"

    - script: |
        sudo apt-get update -y
        sudo apt-get install -y unzip wget
        wget -q https://releases.hashicorp.com/terraform/1.8.5/terraform_1.8.5_linux_amd64.zip
        unzip terraform_1.8.5_linux_amd64.zip
        sudo mv terraform /usr/local/bin/
      displayName: "Install Terraform"

    - script: |
        cd terraform
        terraform init -backend-config="resource_group_name=tfstate-rg" \
                       -backend-config="storage_account_name=<uniquestateaccount>" \
                       -backend-config="container_name=tfstate" \
                       -backend-config="key=${BUILD_BUILDID}.tfstate"
        terraform fmt -check
        terraform plan -out=tfplan
      displayName: "Terraform Init & Plan"

    - script: |
        cd terraform
        terraform apply -auto-approve tfplan
      displayName: "Terraform Apply"